name: CI Pipeline

on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  # Stage 1: Test and Build
  test-build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 20
        uses: actions/setup-java@v3
        with:
          java-version: '20'
          distribution: 'temurin'
          cache: maven
      
      - name: Run Tests
        run: mvn test
      
      - name: Build Application
        run: mvn clean package -DskipTests
      
      - name: Upload JAR
        uses: actions/upload-artifact@v3
        with:
          name: app-jar
          path: target/demo-app.jar

  # Stage 2: Security Check (Dependency Vulnerabilities)
  security-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 20
        uses: actions/setup-java@v3
        with:
          java-version: '20'
          distribution: 'temurin'
          cache: maven
      
      - name: Check for Vulnerable Dependencies
        run: mvn org.owasp:dependency-check-maven:check -DskipProvidedScope=true -DskipTestScope=true
        continue-on-error: true

  # Stage 3: Build Docker Image
  docker-build:
    needs: test-build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download JAR
        uses: actions/download-artifact@v3
        with:
          name: app-jar
          path: target/
      
      - name: Build Docker Image
        run: docker build -t demo-app:latest .
      
      - name: Save Image
        run: docker save demo-app:latest | gzip > demo-app.tar.gz
      
      - name: Upload Image
        uses: actions/upload-artifact@v3
        with:
          name: docker-image
          path: demo-app.tar.gz

  # Stage 4: Test Container
  test-container:
    needs: docker-build
    runs-on: ubuntu-latest
    steps:
      - name: Download Docker Image
        uses: actions/download-artifact@v3
        with:
          name: docker-image
      
      - name: Load Image
        run: docker load -i demo-app.tar.gz
      
      - name: Start Container
        run: docker run -d --name app -p 8080:8080 demo-app:latest
      
      - name: Wait for Startup
        run: sleep 5
      
      - name: Health Check
        run: curl -f http://localhost:8080/health || exit 1
      
      - name: Cleanup
        run: docker stop app || true

  # Stage 5: Push to DockerHub
  push-image:
    needs: test-container
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master'
    steps:
      - name: Download Image
        uses: actions/download-artifact@v3
        with:
          name: docker-image
      
      - name: Load Image
        run: docker load -i demo-app.tar.gz
      
      - name: Login to DockerHub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      
      - name: Push Image
        run: |
          docker tag demo-app:latest ${{ secrets.DOCKERHUB_USERNAME }}/demo-app:latest
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/demo-app:latest
